SELECT st.modality
      , st.study_description
      , st.procedure_description
      , se.series_description
      , decode(base64_data, 'base64') AS img_bytes
  FROM patients p
  JOIN studies st ON p.patient_id = st.patient_id
  JOIN series se ON st.study_instance_uid = se.study_instance_uid
  JOIN instances i ON se.series_instance_uid = i.series_instance_uid
  JOIN instance_images ii ON i.sop_instance_uid = ii.sop_instance_uid
  WHERE 1=1
    AND p.patient_id = 6

--------------------------------------------------------------------------------------


WITH T AS (
  SELECT *
      , CASE 
          WHEN image_orientation IS NULL OR image_orientation = 'None' THEN NULL
          ELSE array(
              SELECT CASE
                       WHEN abs(v::float8) < 1e-1 THEN 0
                       WHEN abs(v::float8 - 1) < 1e-1 THEN 1
                       WHEN abs(v::float8 + 1) < 1e-1 THEN -1
                       ELSE 0
                     END
              FROM jsonb_array_elements_text(image_orientation::jsonb) AS t(v)
          )
      END AS rounded_orientation
  FROM patients p
  JOIN studies st ON p.patient_id = st.patient_id
  JOIN series se ON st.study_instance_uid = se.study_instance_uid
  JOIN instances i ON se.series_instance_uid = i.series_instance_uid
  JOIN instance_images ii ON i.sop_instance_uid = ii.sop_instance_uid
  WHERE p.patient_id = 6
)
, T1 AS (
  SELECT decode(base64_data, 'base64') AS img_bytes
    , CASE
         WHEN rounded_orientation[1:3] = ARRAY[1,0,0] 
              AND rounded_orientation[4:6] = ARRAY[0,1,0] 
           THEN 'Axial'
         WHEN rounded_orientation[1:3] = ARRAY[0,1,0] 
              AND rounded_orientation[4:6] = ARRAY[0,0,-1] 
           THEN 'Sagittal'
         WHEN rounded_orientation[1:3] = ARRAY[1,0,0] 
              AND rounded_orientation[4:6] = ARRAY[0,0,-1] 
           THEN 'Coronal'
         ELSE 'Unknown'
       END AS plane
FROM T
)
SELECT * FROM T1 WHERE plane = 'Sagittal';





-----------------------------------------------------------------------------



SELECT *
      , decode(base64_data, 'base64') AS img_bytes
  FROM patients p
  JOIN studies st ON p.patient_id = st.patient_id
  JOIN series se ON st.study_instance_uid = se.study_instance_uid
  JOIN instances i ON se.series_instance_uid = i.series_instance_uid
  JOIN instance_images ii ON i.sop_instance_uid = ii.sop_instance_uid
  WHERE 1=1
    AND se.series_description LIKE '%t2%' 
    AND p.patient_id = 6


  --------------------------------------------------------------------------


  SELECT
       embedding
    , 1- (embedding <#> 
'[0.02036978,0.015589975,0.0028084035,0.022924246,-0.024248885,-0.017403431,-0.025804987,0.004093039,0.031355377,-0.034394138,0.06360316,0.024782268,0.028930219,0.016213011,-0.009594177,-0.06965859,0.07333741,0.021399532,0.0017282143,0.04378473,-0.040086962,-0.0038199604,0.03755345,0.063090384,-0.037745137,-0.044150345,-0.03002407,0.006876954,-0.030787777,0.0107278945,6.159806e-05,0.03854205,-0.011785202,-0.059065122,0.0024540261,-0.0018393599,0.037430335,-0.04214363,-0.020661425,-0.090830795,-0.01632643,-0.0051502343,-0.034439214,-0.055657223,0.082956515,-0.1477395,-0.064933315,0.052613772,-0.020317607,-0.057453435,0.052727565,-0.014884103,-0.005117382,-0.052680027,-0.014197933,0.031177782,-0.005254797,-0.027108885,0.0006386211,0.008165019,0.116552226,0.035868373,0.026394142,0.0062009464,-0.023563456,0.025211003,0.009641849,0.057349924,-0.013092305,-0.029508313,-0.0019854242,-0.006674406,-0.009609436,-0.046591327,-0.027405823,0.013025517,-0.024383552,0.0010580723,0.0021704198,0.049494814,-0.02091947,0.0071039973,-0.06583391,-0.0134809315,-0.013767104,-0.01271996,0.1237671,0.029954905,-0.00596835,0.015643368,-0.009402665,-0.04347894,-0.55233485,0.007963136,-0.0029276565,-0.026019324,0.005461601,-0.03096256,-0.029147947,0.040615033,0.013228091,-0.04324074,0.02478851,0.039231904,0.04607883,0.018850878,-0.10651047,0.031302873,0.0028312746,0.0036398661,0.0115017565,-0.038722288,-0.026756313,0.00354611,0.018205898,-0.03014976,0.046989735,-0.017775685,0.026040297,0.019838182,-0.018334001,-0.047963064,-0.037097692,-0.017871004,0.011798739,0.040320393,-0.030388657,-0.039859857,-0.0013955082,-0.003204884,-0.008754403,0.011653124,0.023173872,0.08130274,0.027791288,-0.015940055,-0.022606801,-0.09226812,0.047022115,0.0022690645,-0.021446986,0.02398186,-0.0790878,0.043262236,0.0044282516,-0.015237937,0.013700942,0.039420843,0.000753142,-0.021989567,-0.020603288,-0.036395904,0.021660937,-0.029402653,-0.010024532,-0.043276187,-0.017867109,-0.06998295,0.0658884,-0.0016361215,-0.005569075,-0.01723889,-0.009736321,-0.00047418012,-0.025084337,0.03249179,-0.08369224,-0.011717698,0.031019976,0.010703276,0.01130733,-0.0066917134,0.017579712,-0.012459211,-0.00010316454,-0.02002633,-0.044858318,-0.02565755,-0.0007240239,-0.008984259,-0.038739853,-0.03768968,-0.018400047,-0.020226462,-0.012014971,0.003872902,0.028059183,-0.0050261035,0.016591359,0.005595806,-0.019340752,0.022115177,0.0048744823,-0.038011983,0.046778318,-0.007963465,-0.035633042,-0.025657162,-0.027186798,0.006173094,-0.0014177549,0.011399609,0.033689965,0.011597548,0.015834672,-0.035325814,0.07116916,-0.0034273195,-0.0116124805,0.0049001593,-0.021184422,0.077368826,-0.001603815,-0.0032152927,0.03516834,0.03735902,0.01722682,-0.011714488,-0.100979365,0.0263981,-0.01672385,0.02909358,0.0011211754,-0.0006463984,-0.048442278,0.0073662647,0.007994529,0.025425514,-0.019807575,-0.02057786,0.012891072,0.017016305,-0.011315402,0.018342236,0.016850522,-0.005532764,0.028530119,-0.02282177,-0.03886237,-0.006443064,0.0025604675,0.031168288,0.024666075,-0.003434672,-0.007835601,-0.070103526,0.015181966,0.020509912,-0.017462695,-0.062126603,-0.049562033,0.0060456344,0.012721862,0.0012357569,-0.005014912,0.008535483,-0.029143536,0.022940604,0.01345747,0.05049489,0.012008479,0.022783373,-0.032104574,-0.049639393,0.033036128,0.0046269763,0.013410052,-0.047509603,0.015974516,-0.011715634,-0.019415947,0.017327443,0.003930407,-0.025858343,-0.020604033,-0.029370723,-0.01226712,0.006089964,-0.003651557,-0.023872204,0.007606194,0.018753868,-0.0071311356,0.0049810763,-0.055047188,0.016653197,-0.07765368,0.0044447645,0.015651667,0.003741971,-0.020908423,0.0099155605,0.025900273,0.010263337,0.03596563,-0.0016242929,-0.033651657,-0.013546495,-0.014165101,-0.02264782,-0.0035013333,-0.021571912,-0.06430131,-0.0029445763,0.010288801,-0.076972134,-0.03844548,0.02815822,0.023185084,0.022623995,-0.029302353,0.02446018,0.08117443,0.03169612,0.05767186,0.069718346,-0.013636606,-0.011216884,-0.023909837,0.0023329996,0.040723115,0.21803778,0.0022578037,-0.008420182,0.013748311,0.005522573,-0.015902713,0.037001755,-0.015146991,0.004770691,-0.01942075,0.019488953,0.016374368,0.02249107,-0.018466173,-0.052680414,0.006395786,0.046637133,0.0105954055,0.03544103,-0.052576832,0.015613942,0.018082222,-0.007124918,-0.020244725,0.022377249,-0.051875662,-0.030303119,-0.036660124,0.004935624,0.08249075,0.0046581044,-0.00067561824,-0.02223828,0.012091033,0.02015395,-0.00494,-0.0659475,0.02561891,-0.01663205,0.025335258,0.021192957,-0.015471419,-0.08078283,-0.031606875,0.009883581,-0.036363672,-0.14964709,0.011756913,0.01291066,0.02286299,0.019183854,-0.0091418205,0.040839046,0.029494742,-0.0023680283,0.041301735,0.012602682,-0.0877187,-0.042325765,0.033670783,-0.024878638,0.06877006,0.04842562,0.019481704,-0.0022301145,-0.019642366,-0.036522977,0.011244973,-0.049806677,0.0021968503,0.021371765,0.026634565,-0.012855814,0.005960678,-0.0006963456,0.0040141125,0.014563758,0.01500616,-0.03334337,0.026338372,-0.018064048,0.11847755,0.023474995,0.054667838,-0.049005594,0.0066208225,0.024847392,0.009467559,-0.049042985,-0.021209294,0.009680069,-0.027375814,-0.003014417,0.011437184,-0.034992926,-0.01761079,-0.020159526,0.012133093,-0.012551707,0.027003232,-0.08992995,-0.028031807,0.069619216,0.004774599,-0.03264391,-0.018950831,0.006490428,-0.1948235,0.0076028546,0.0100481,-0.0344657,-0.07004617,-0.023570636,-0.020736266,0.032525104,-0.079101935,0.027469143,-0.020279445,0.028209371,0.01142096,-0.00087014673,0.056435872,0.030382795,0.0054320237,-0.0011971596,0.033544917,0.0042805555,-0.050504386,0.00550753,-0.037226766,-0.001468137,0.04134516,-0.043815203,-0.024743631,-0.0033700992,-0.0034319682,0.028391793,0.010593813,0.01587596,0.013961984,0.029624203,0.036456827,-0.0119665675,0.033476576,0.016683763,-0.019114701,0.0086837625,0.02713961,-0.009795659,-0.017653259,0.020259809,0.036583643,0.009855777,0.00075794396,-0.04372311,-0.0011390556,-0.015819756,-0.026438285,0.056551933,0.016147526,0.005094407,0.06442181,0.025227407,-0.023206808,-0.043176178,-0.015751954,-0.024903037,-0.08362165,-0.08786231,0.018566625,-0.033341862,0.006193418,-0.020401727,-0.010292442,0.04832583,0.051341537,0.026052488,0.026260775,0.0042143497,0.02161146,0.013799331,0.021874353,-0.041766632,-0.028093299,0.021775914,-0.029114664,-0.009143143,-0.051903304,0.035047982,0.006157417,0.007781879]'::vector
  ) AS similarity
  , decode(base64_data, 'base64') AS img_bytes
FROM instance_images
ORDER BY similarity


-------------------------------------------------------------------------------

SELECT image_id,
       embedding
    , 1- (embedding <#> 
'[0.012803875,0.03553199,-0.006360293,0.024684893,-0.009483032,-0.0074060867,0.018080406,0.04984676,-0.011371828,-0.0015974706,0.02175993,-0.017236572,0.04007978,0.0074780015,-0.020074105,-0.04834898,-0.05553622,0.004422055,0.030654615,0.021615274,-0.01730977,-0.020925302,0.021117464,0.016136395,0.012742396,-0.0030898768,-0.021586886,-0.011210331,-0.010496048,0.009785923,-0.021688862,-0.0009082167,0.0004820493,-0.0011902748,-0.07831916,-0.0005320661,-0.034005903,0.013889906,0.031094769,-0.0033132955,-0.03491124,-0.0224841,-0.03997751,-0.014180729,-0.0087088235,0.11440315,0.018889103,0.021259839,-0.037576485,-0.020213494,0.008130114,0.010761368,-0.005364089,-0.043887887,-0.0051511014,0.013561723,-0.013616618,0.010208734,-0.0116998805,0.0037644012,0.00035741407,-0.002600075,-0.030697143,0.022894366,-0.004049101,0.00750121,0.0011151115,-0.042426705,-0.012291692,0.0073896665,-0.033329815,-0.010058101,-0.009852681,-0.046581022,-0.0321149,-0.012267736,-0.032311026,-0.023501372,0.005029646,0.014175778,-0.025488432,-0.017638266,-0.001198421,-0.018943597,-0.0016803435,0.012712099,0.07554183,0.02894809,0.046642013,-0.0015632077,0.002937178,0.0044286684,-0.7432687,0.0013473717,0.016196635,0.015385031,0.0027816098,-0.0054862034,-0.017775232,-0.06934145,0.026895776,0.0028921633,0.023705218,-0.0023978914,0.044517945,0.010065213,-0.032099515,0.011103068,-0.013347314,0.00802246,-0.020189365,-0.020326074,-0.03814856,-0.018235102,-0.005352991,-0.036576852,-0.0015837704,-0.030016964,0.0027022262,-0.010311237,-0.03346002,-0.06859928,-0.031643134,0.001653791,0.0097802915,-0.0017226302,0.009021857,-0.00011358228,-0.009472281,0.03405035,-0.013616101,-0.009882905,0.0075254836,0.093623266,0.06833254,-0.014674962,-0.016738001,-0.049207762,-0.0015442944,-0.012497464,-0.0005696003,-0.008812556,-0.034115717,-0.010814644,-0.007014194,0.03449315,0.0091689015,0.022770643,-0.021218097,-0.025564231,-0.006733797,-0.034252968,0.03107088,-0.026255548,0.034547564,-0.043231018,0.010941923,0.00047040445,0.047618125,-0.008895225,0.023501026,-0.035313513,-0.035712015,0.017179066,0.007337078,0.033394087,-0.08162738,0.0079981135,0.03196394,0.025492951,0.007030632,-0.002023667,0.024835858,-0.017903734,0.005647781,0.019629762,0.076846674,-0.009282988,-0.012130689,0.014512421,-0.032459337,-0.016487423,-0.00883428,-0.01715496,-0.005422955,0.0031517684,-0.005552262,0.02005871,0.036559407,0.019660791,0.03193444,-0.0017679082,-0.022359999,-0.015022223,0.018026149,-0.028839922,0.012602758,-0.010717886,-0.047812875,-0.0031757285,0.0023273013,-0.020874847,-0.016535811,0.019892214,-0.0051666154,-0.005980125,0.0017582284,0.034855228,-0.0032248541,-0.0041916827,0.018688729,0.06514143,0.00018572572,-0.002455377,-0.0033126497,0.016752783,0.0051293387,-0.010052807,-0.026988445,-0.029113457,0.010462629,0.002334013,-0.0025031432,-0.016362231,-0.023736048,-0.010698808,0.020613438,-0.01465867,0.009978557,-0.020227922,0.050533626,-0.003598387,0.0011108838,0.028003916,-0.006541609,0.03327418,-0.010278982,0.0069092084,-0.0303298,0.023387335,-0.016968725,-0.009006906,0.034331888,-0.01608842,0.004386329,-0.106938064,0.0034093633,0.012757297,-0.023818558,-0.03983016,-0.016259829,-0.0077604726,-0.004747905,-0.0022843208,0.0060022664,-0.006316837,-0.028577272,0.02722424,-0.053846445,0.043923497,0.014113161,0.009989996,-0.0012793449,-0.14784466,-0.0021375713,0.0063642417,0.0039230646,-0.04432728,0.023056496,-0.016649602,0.03304062,-0.0044061206,0.0013388835,0.015393402,-0.0113181425,-0.0063803494,0.025794338,-0.011414571,-0.015225774,-0.03410598,-0.007877023,-0.015385701,-0.033384047,-0.0016905802,-0.0253288,0.0074176933,-0.03924405,0.011003545,0.015630055,0.02216337,-0.0029590386,-0.017887402,0.022570575,0.01774074,0.042852443,0.03556052,-0.0010622808,-0.003517987,0.009710118,-0.018408252,0.0012312039,-0.04730214,-0.032555617,0.00432192,-0.007933794,-0.0546095,0.0012070094,-0.0125526,0.017806198,-0.009012554,-0.020521589,-0.0019231525,0.0934209,0.030837908,0.019131055,0.010920884,-0.0080322735,0.0020828662,-0.005432743,-0.044067908,-0.003505962,0.07015298,0.011394786,0.0056798244,-0.033920784,0.02832361,0.013186149,0.03167047,0.012627461,0.07043508,-0.025690889,0.007416636,0.018404901,-0.016186185,-0.009869281,-0.021739326,-0.03252557,0.026569072,-0.030718138,-0.038486782,0.011450911,0.0019896443,0.021547593,-0.0028425017,-0.011458604,-0.0212819,-0.009814893,0.01437743,0.0066991723,0.0040597715,0.06593214,-0.026471104,0.015523295,-0.021159025,0.003013753,-0.037496302,0.023346387,0.056856565,0.03341574,-0.008968062,0.00892304,0.023423266,0.015900768,-0.015124705,-0.013483594,8.398923e-05,-0.027802309,-0.082320236,-0.02986459,0.0014778464,0.008468905,-0.027874716,-0.0040322817,0.0022654384,0.014439831,-0.025084157,0.1216457,-0.0021779633,-0.07524113,0.004673238,0.022322055,-0.024785288,0.023135098,-0.030125111,-0.0051618777,-0.0025670556,0.022002399,-0.024609737,-0.062087525,0.17285988,0.040105198,-0.003224937,0.023546673,-0.040609855,-0.019742634,-0.025484342,-0.0065860124,-0.012300695,-0.0068407534,0.021439586,0.030195044,-0.002106183,0.018128568,-0.011228702,0.0053626345,-0.05655386,-0.0019078169,0.0063189473,0.025604032,-0.013771574,-0.021695683,0.029016707,-0.028492214,0.03856791,0.030978065,0.039567694,0.018518584,0.026534008,0.010319578,0.005680349,0.019101977,-0.048800822,-0.019457571,0.103521235,0.014688808,-0.0369008,-0.032491714,-0.037221376,0.09720933,0.00295553,0.033326488,0.040149074,-0.07548898,-0.07053869,0.018846285,-0.0032108908,-0.025201498,-0.0017087078,-0.03476978,0.02177001,0.011370401,0.028416483,0.008129996,0.010529022,0.002641785,0.004171566,-0.0053203036,0.008404892,-0.008809871,-0.008505901,-0.032488503,0.009694082,0.010784174,-0.06194788,0.0009691064,0.0044645052,-0.00042348745,0.0020123029,-0.02299253,0.030971274,0.012032221,0.0024319296,0.0032415108,-0.004023105,0.003067928,-0.01284633,-0.008601944,-0.0052915392,0.005716296,0.014269366,-0.05780981,0.020512484,-0.022039331,-0.0031795742,-0.028110769,-0.028224036,0.024028938,-0.005876477,-0.011464771,-0.031989887,-0.0018769169,-0.02397183,0.031841304,0.015737932,0.004242366,-0.025862899,-0.0050491635,-0.022444548,-0.0495886,-0.028095668,0.018903203,-0.027158787,-0.031229496,-0.0089320745,-0.028636213,-0.0063510705,-0.01331643,0.022171114,-0.006541477,-0.008263684,0.002870325,-0.0010686336,-0.025130365,0.025442107,0.035111513,-0.0040052263,0.0058827237,-0.038348746,-0.022220839,0.0466955,-0.00067648286,0.033367068]'::vector  
  ) AS similarity
  , decode(base64_data, 'base64') AS img_bytes
FROM instance_images
ORDER BY similarity;